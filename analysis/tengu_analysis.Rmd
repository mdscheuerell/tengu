---
title: "Shifts in the size of fish from a culturally important recreational fishery"
author: "Mark Scheuerell"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  pdf_document:
    highlight: haddock
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")

library(dplyr)
library(MARSS)

## plot hook to increase margins
local({
  hook_old <- knitr::knit_hooks$get("plot")  # save the old hook
  knitr::knit_hooks$set(plot = function(x, options) {
    x <- c("\\vspace{0.5in}", hook_old(x, options))
  })
})

## better captions
library("captioner")
## set default caption delimter
fig_cap <- captioner(suffix = ".", style = "b", style_prefix = TRUE)
```


# Data

The original data were provided to me by Tom Quinn on 16 June 2020 in the form of an MS Excel file titled `Tengu_derby_leaders through 2019 derby.xls`. I exported the one worksheet of interest (`data in kg`) as `~/data/tengu_derby_data.csv`.

```{r import_data}
## set data dir
datadir <- here::here("data")
## import raw data
raw_data <- readr::read_csv(file.path(datadir, "tengu_derby_data.csv"))
```

## Fishing effort

This dataset lacks the necessary detail to calculate a proper index of the catch per unit effort (CPUE) because effort is ill-defined. That is, although we know the total number of days per year the derby was open and the total number of anglers that participated per year, we don't know how many days *each* angler fished. Therefore, we assumed that each angler fished every day the derby was open, which is almost certainly an overestimate of the true effort, but we have no reason to believe there would be any systematic change over time.

```{r calculate_cpue, fig.dim = c(6, 4)}
## CPUE
cpue <- raw_data$total_catch / (raw_data$days * raw_data$members)

## time series plot of CPUE
par(mai = c(0.9, 0.9, 0.1, 0.1))
plot.ts(ts(cpue, start = min(raw_data$year)), lwd = 2, col = "blue",
        las = 1, log = "y",
        ylab = "CPUE", xlab = "Year", yaxt = "n")
axis(2, at = c(0.01, 0.02, 0.05, 0.1), las = 1)
```

\setlength{\leftskip}{0.5in}
\setlength{\rightskip}{0.5in}

\small

`r fig_cap(1, caption = "Time series of catch per unit effort of blackmouth from the Tengu Derby. Note that the y-axis is on a natural log scale.", display = "full")` 

\normalsize

\setlength{\leftskip}{0in}
\setlength{\rightskip}{0in}


# Changes in catch over time

The CPUE appears to generally decline over time, so I fit two random walk models (with and without a bias term) to estimate the data support for a decline. Because CPUE is necessarily bounded by zero at a minimum, I fit models to the log-transformed CPUE. Specifically, the models are

\begin{equation}
c_t = c_{t-1} + u + e_t
\end{equation}

and \begin{equation}
c_t = c_{t-1} + e_t
\end{equation}

where $c_t$ is the log$_e$-transformed CPUE, $u$ is a bias term, and $e_t \sim \text{N}(0, \sigma)$.

```{r model_setup}
## model setup
mod_list <- list(
  B = matrix(1),
  U = matrix("u"),
  Q = matrix("q"),
  Z = matrix(1),
  A = matrix(0),
  R = matrix(0)
)
## response
l_cpue <- matrix(log(cpue), nrow = 1)
```

## Fit biased random walk

```{r biased_RW_CPUE}
## fit model with bias (Eqn 1)
cpue_brw <- MARSS(l_cpue, model = mod_list)

## 95% CI for bias
cpue_brw <- MARSSparamCIs(cpue_brw)
```

## Fit unbiased random walk

```{r unbiased_RW_CPUE}
## fit model without bias (Eqn 2)
mod_list$U <- matrix(0)
cpue_rw <- MARSS(l_cpue, model = mod_list)
```

\vspace{0.25in}

The 95% confidence interval for the bias term $(u)$ is (`r round(c(cpue_brw$par.lowCI$U, cpue_brw$par.upCI$U), 2)`), and the model with a bias term has an AIC value ~`r round(diff(AIC(cpue_rw, cpue_brw)$AIC), 1)` units greater than the model without a bias term, suggesting there is no data support for a systematic downward trend in the log-transformed CPUE over time.

## Variance in catch over time

The time series of CPUE (Figure 1) appears to exhibit increasing variance over time, so here is a plot of the residuals from the better fitting random walk model (Eqn 2).

```{r plot_cpue_rw_resids, fig.dim = c(6, 4)}
## Model residuals
cpue_rw_resids <- t(residuals(cpue_rw)$state.residuals)

## time series plot of CPUE
par(mai = c(0.9, 0.9, 0.1, 0.1))
plot.ts(ts(cpue_rw_resids, start = min(raw_data$year)), lwd = 2, col = "blue",
        las = 1, ylab = "Model residuals", xlab = "Year")
```

\setlength{\leftskip}{0.5in}
\setlength{\rightskip}{0.5in}

\small

`r fig_cap(2, caption = "Time series of the residuals from the random walk model (Eqn 2).", display = "full")` 

\normalsize

\setlength{\leftskip}{0in}
\setlength{\rightskip}{0in}

\vspace{0.25in}

The residuals do indeed appear heteroscedastic with increasing variance over time. The model was fit to log-transformed CPUE, so it's not clear another transformation would help.


# Changes in fish size over time

The data set contains three different indicators of fish size over time:

1) the total number of fish over 10 pounds (~4.55 kg);

2) the total number of fish over 5 pounds (~2.27 kg); and

3) the masses (kg) of the 5 largest fish.

Clearly (1) and (2) will be correlated, as (1) is a subset of (2). To see how they relate to (3), I summed the sizes of the 5 largest fish and compare that metric to (1) and (2). Here are the correlations among the three.

```{r size_corr}
## total mass of 5 largest fish
sum_of_top_5 <- apply(raw_data[,c(9:13)], 1, sum, na.rm = TRUE)
sum_of_top_5[sum_of_top_5 == 0] <- NA

## 3 size metrics
fish_sizes <- cbind("N over 10 lbs" = raw_data$n_over_10,
                    "N over 5 lbs" = raw_data$n_over_5,
                    "Sum of top 5 (kg)" = sum_of_top_5) %>%
  ts(start = min(raw_data$year))

## correlation among the 3 metrics
cor(fish_sizes, use = "pairwise.complete.obs") %>%
  round(2)
```

\vspace{0.25in}

As suspected, all three metrics are correlated, with the total number of fish over 10 pounds and the total mass (kg) of the five largest fish being particularly so.

Here are plots of the three size metrics over time.

```{r ts_plot_sizes, fig.dim = c(6, 8)}
## time series plot of fish size metrics
par(mai = c(0.9, 0.9, 0.1, 0.1))
plot.ts(fish_sizes, lwd = 2, col = "blue",
        main = "", yax.flip = TRUE,
        ylab = c("", "", ""), xlab = "Year")
```

\setlength{\leftskip}{0.5in}
\setlength{\rightskip}{0.5in}

\small

`r fig_cap(3, caption = "Time series of fish size over time, including the total number of fish over 10 pounds (top), the total number of fish over 5 pounds (middle), and the total mass (kg) of the five largest fish (bottom).", display = "full")` 

\normalsize

\setlength{\leftskip}{0in}
\setlength{\rightskip}{0in}

\vspace{0.25in}

There appears to be an overall decline in fish size from the mid 1940s until the mid 1980s, when fish sizes increased rapidly before declining again until present.


## Fit biased random walk

Just as I did with the CPUE data, I fit both biased and unbiased forms of random walk models to the fish size data. Here I use the log-transformed sum of the five largest fish.

```{r model_setup_2}
## model setup
mod_list <- list(
  B = matrix(1),
  U = matrix("u"),
  Q = matrix("q"),
  Z = matrix(1),
  A = matrix(0),
  R = matrix(0)
)
## response
l_size <- matrix(log(sum_of_top_5), nrow = 1)
```

```{r biased_RW_size}
## fit model with bias (Eqn 1)
size_brw <- MARSS(l_size, model = mod_list)

## 95% CI for bias
size_brw <- MARSSparamCIs(size_brw)
```

## Fit unbiased random walk

```{r unbiased_RW_size}
## fit model without bias (Eqn 2)
mod_list$U <- matrix(0)
size_rw <- MARSS(l_size, model = mod_list)
```

\vspace{0.25in}

The 95% confidence interval for the bias term $(u)$ is (`r round(c(size_brw$par.lowCI$U, size_brw$par.upCI$U), 2)`), and the model with a bias term has an AIC value ~`r round(diff(AIC(size_rw, size_brw)$AIC), 1)` units greater than the model without a bias term, suggesting there is no data support for a systematic downward trend in the log-transformed size over time.

### Model fit to size data

```{r plot_size_rw, fig.dim = c(6, 4)}
## time series plot of size & model fit
par(mai = c(0.9, 0.9, 0.1, 0.1))
plot.ts(ts(t(l_size), start = min(raw_data$year)), lwd = 2, col = "blue",
        las = 1, ylab = "Sum of top 5 (kg)", xlab = "Year")
lines(ts(t(size_brw$states), start = min(raw_data$year)))
```

